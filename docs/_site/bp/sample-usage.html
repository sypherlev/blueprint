<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>sypherlev/blueprint : Sample Usage</title>
        <meta name="description" content="A better SQL query compiler for managing complex data">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/blueprint/css/syntax.css">
        <link rel="stylesheet" href="/blueprint/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/blueprint/">sypherlev/blueprint</a>
    <small>A better SQL query compiler for managing complex data</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/blueprint/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Blueprint</li>
            
            <li data-order=""><a href="/blueprint/bp/sample-usage.html">Sample Usage</a></li>
        
    
        
        

        
            
                <li class="nav-header">The Query Builder</li>
            
            <li data-order=""><a href="/blueprint/qb/the-query-builder.html">Basic Usage</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/query-command-methods.html">Query Command Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/termination-methods.html">Termination Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/utility-and-debugging-methods.html">Utility and Debugging Methods</a></li>
        
    
        
        

        
            
                <li class="nav-header">Patterns</li>
            
            <li data-order=""><a href="/blueprint/pat/pattern-methods.html">Pattern Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/pat/using-patterns.html">Using Patterns</a></li>
        
    
        
        

        
            
                <li class="nav-header">Filters</li>
            
            <li data-order=""><a href="/blueprint/fil/filter-methods.html">Filter Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/fil/using-filters.html">Using Filters</a></li>
        
    
        
        

        
            
                <li class="nav-header">Transformations</li>
            
            <li data-order=""><a href="/blueprint/tra/using-transformations.html">Using Transformations</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Sample Usage
        
    </h2>
</div>

<p>Classes which interact with the database are normally called models; this is not true of Blueprint, as its core functionality is to define how to access and manipulate data, not define it. For the sake of having some kind of convention, I call them <code class="highlighter-rouge">SomethingData</code>.</p>

<p>Each Data class’s constructor should include whatever Patterns, Filters and Transformations you require (because it’s convenient), but you can put them in their own methods and initialize them as needed if you like.</p>

<p><strong>Patterns, Filters and Transformations cannot be removed once added. They can only be overwritten with a new element of the same name.</strong></p>

<p>Blueprint object example:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>class UserData extends Blueprint
{
    public function __construct(SourceInterface $source) {
        parent::__construct($source);
 
        // add patterns
        $this-&gt;addPattern('summary', function() {
            return (new Pattern())-&gt;table('users')
                -&gt;join('users', 'users_extended', ['id' =&gt; 'user_id'], 'LEFT')
                -&gt;join('users', 'businesses', ['id' =&gt; 'user_id'], 'LEFT')
                -&gt;columns([
                    'users' =&gt; ['id', 'username', 'first_name', 'last_name'],
                    'users_extended' =&gt; ['profile_pic'],
                    'businesses' =&gt; ['city', 'province']
                ]);
        });
 
        $this-&gt;addPattern('whole', function(){
            return (new Pattern())-&gt;table('users')
                -&gt;join('users', 'users_extended', ['id' =&gt; 'user_id'], 'LEFT')
                -&gt;join('users', 'businesses', ['id' =&gt; 'user_id'], 'LEFT')
                -&gt;columns([
                    'users' =&gt; ['id', 'username', 'first_name', 'last_name'],
                    'users_extended' =&gt; ['*'],
                    'businesses' =&gt; ['*']
                ]);
        });
 
        // add filters
        $this-&gt;addFilter('onlyActive', function(){
            return (new Filter())-&gt;where(['active' =&gt; 1]);
        });
 
        // add transformations
        $this-&gt;addTransformation('convertTimes', function($record){
            if(isset($record-&gt;created)) {
                $record-&gt;created = date('Y-m-d', $record-&gt;created);
            }
            return $record;
        });
    }
}
</code></pre>
</div>

<p>The constructor accepts a Source - this is the database object through which queries will be run. Then three sections are defined - Patterns, Filters, and Transformations. Each one is defined by the following syntax:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$this-&gt;addPattern('patternname', function() {...});
</code></pre>
</div>

<p>The second argument for addPattern or addFilter should be a closure that produces an object of the relevant type. The second argument for addTransformation should be a closure that returns the same record entity passed into the function.</p>

<h3 id="sample-functions">Sample Functions</h3>

<p>In the User object itself, here are some possible functions for retrieving data:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public function getUser($id, $pattern = 'whole') {
    return $this
        -&gt;select()
        -&gt;withPattern($pattern)
        -&gt;where(['users' =&gt; ['id' =&gt; $id]])
        -&gt;withTransformation('convertTimes')
        -&gt;one();
}

public function getUserByUsername($username, $pattern = 'whole') {
    return $this
        -&gt;select()
        -&gt;withPattern($pattern)
        -&gt;withTransformation('convertTimes')
        -&gt;where(['users' =&gt; ['username' =&gt; $username]])
        -&gt;one();
}

public function getUserList() {
    return $this
        -&gt;select()
        -&gt;withPattern('summary')
        -&gt;withFilter('onlyActive')
        -&gt;withTransformation('convertTimes')
        -&gt;many();
} If you've ever used a query builder, the methods above should look familiar. When the termination methods are called (`one()`, `many()`, `execute()`, `count()`), any chosen Pattern and Filter is added to the query.
</code></pre>
</div>

<p>Transformations are applied to records returned from any SELECT(), and any passed into INSERT() and UPDATE(). You may find it tricky to apply the same Transformation both ways.</p>

<p>Here’s some create and update functions:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public function insertUser(Array $user) {
    return $this
        -&gt;insert()
        -&gt;withPattern('summary')
        -&gt;add($user)
        -&gt;execute();
}

public function updateUser($id, Array $userUpdate) {
    return $this
        -&gt;update()
        -&gt;withPattern('summary')
        -&gt;withFilter('onlyActive')
        -&gt;set($userUpdate)
        -&gt;where(['id' =&gt; $id])
        -&gt;execute();
}
</code></pre>
</div>

<p>In the insertUser function, invoking the ‘summary’ pattern means that Blueprint will try to insert a record into the table ‘users’ using the array $user, where the only allowed fields are those listed for the table ‘users’ in the Pattern. Therefore the array may only consist of the following:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>[
    'id' =&gt; '...',
    'username' =&gt; '...',
    'first_name' =&gt; '...',
    'last_name' =&gt; '...'
]
</code></pre>
</div>

<p>If any other array keys are present that don’t match the list allowed by the Pattern for the primary table, an exception will be thrown. (This validation is designed to prevent SQL injection in the column names.)</p>

<p>The same applies for the updateUser function. As long as a Pattern is invoked, Blueprint will validate the data first. It will not ensure that all fields are present; it only ensures that the given fields are whitelisted. This means that you may add a single Pattern that defines which fields are editable in a particular table, and use it for any number of queries that edit that table.</p>

<p>You can specify different Patterns for what data may be edited, vs. what data may be inserted.</p>

<p>For more simple tables, you can define a single Pattern and apply it to all queries.</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/sypherlev/blueprint">sypherlev/blueprint</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
