<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>sypherlev/blueprint : Using Transformations</title>
        <meta name="description" content="A better SQL query compiler for managing complex data">

        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/blueprint/css/syntax.css">
        <link rel="stylesheet" href="/blueprint/css/main.css">
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div id="header" class="col-sm-12">
                    <h4><a class="brand" href="/blueprint/">sypherlev/blueprint</a>
    <small>A better SQL query compiler for managing complex data</small>
</h4>

                </div>
            </div>

            <div class="row">
                
                
                    <div id="navigation" class="col-sm-2">
                        <ul class="nav nav-list">
    <li><a href="/blueprint/">Home</a></li>
    
        
        

        
            
                <li class="nav-header">Blueprint</li>
            
            <li data-order=""><a href="/blueprint/bp/sample-usage.html">Sample Usage</a></li>
        
    
        
        

        
            
                <li class="nav-header">The Query Builder</li>
            
            <li data-order=""><a href="/blueprint/qb/the-query-builder.html">Basic Usage</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/query-command-methods.html">Query Command Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/termination-methods.html">Termination Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/qb/utility-and-debugging-methods.html">Utility and Debugging Methods</a></li>
        
    
        
        

        
            
                <li class="nav-header">Patterns</li>
            
            <li data-order=""><a href="/blueprint/pat/pattern-methods.html">Pattern Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/pat/using-patterns.html">Using Patterns</a></li>
        
    
        
        

        
            
                <li class="nav-header">Filters</li>
            
            <li data-order=""><a href="/blueprint/fil/filter-methods.html">Filter Methods</a></li>
        
            
            <li data-order=""><a href="/blueprint/fil/using-filters.html">Using Filters</a></li>
        
    
        
        

        
            
                <li class="nav-header">Transformations</li>
            
            <li data-order=""><a href="/blueprint/tra/using-transformations.html">Using Transformations</a></li>
        
    
<!-- List additional links. It is recommended to add a divider
    e.g. <li class="divider"></li> first to break up the content. -->
</ul>

                    </div>

                    <div id="content" class="col-sm-10">
                        <div class="page-header">
    <h2>Using Transformations
        
    </h2>
</div>

<p>The third part of Blueprint is the <strong>Transformation</strong> - a function which is called before or after the query, and modifies its input/output in some way.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$this-&gt;addTransformation('convertTimes', function($record){
    if(isset($record-&gt;created)) {
        $record-&gt;created = date('Y-m-d', $record-&gt;created);
    }
    return $record;
});
</code></pre>
</div>

<p>When applying a Transformation, Blueprint will pass the input or output into the Transformation function. (If it receives an array, it will loop over the array and pass each element into the function.) When applied to an INSERT or UPDATE, the Transformation is performed on the input before the query is performed. When applied to a SELECT, the Transformation is applied to the query’s output.</p>

<p>Transformations are best used in the form above - working on a single record, assumed to be a plain PHP object, with a check to make sure that the field it’s operating on exists. But it’s also possible to apply a Transformation to a whole array of records going in or out of the database.</p>

<p>Set the closure to expect an array, and set the last argument of <code class="highlighter-rouge">addTransformation</code> to true.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$this-&gt;addTransformation('uppercaseName', function(Array $records){
    foreach ($records as $idx =&gt; $record) {
        if(isset($record-&gt;name)) {
            $record[$idx]-&gt;name = strtoupper($record-&gt;name);
        }   
    }
    return $records;
}, true);
</code></pre>
</div>

<p>Transformations are also used to append to a dataset or run queries one after another.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$this-&gt;addTransformation('getComments', function($record) use ($this) {
    if(isset($record-&gt;id)) {
        $record-&gt;comments = $this-&gt;getComments($record-&gt;id);
    }
    return $record;
});
</code></pre>
</div>

<p><strong>Be careful with this.</strong> It’s very possible to trash your database if you apply this kind of Transformation to a large dataset, because it runs in a loop.</p>


                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="https://github.com/sypherlev/blueprint">sypherlev/blueprint</a>

                </div>
            </div>
        </div>

        <script>
            function orderNav() {
                var list,
                    section,
                    header,
                    sections = [],
                    lists = {},
                    headers = {};

                var navUl = document.querySelectorAll('#navigation ul')[0],
                    navLis = document.querySelectorAll('#navigation ul li');

                if (!navUl) return;

                for (var i = 0; i < navLis.length; i++) {
                    var order, li = navLis[i];

                    if (li.classList.contains('nav-header')) {
                        section = li.textContent || li.innerText;
                        sections.push(section);
                        headers[section] = li;
                        continue;
                    }

                    if (!lists[section]) {
                        lists[section] = [];
                    }

                    order = parseFloat(li.getAttribute('data-order'))
                    lists[section].push([order, li]);
                }

                for (var i = 0; i < sections.length; i++) {
                    section = sections[i];
                    list = lists[section].sort(function(a, b) {
                        return a[0] - b[0];
                    });

                    if (header = headers[section]) {
                        navUl.appendChild(header);
                    }
                    for (var j = 0; j < list.length; j++) {
                        navUl.appendChild(list[j][1]);
                    }
                }
            }

            if (document.querySelectorAll) orderNav();
        </script>
        
    </body>
</html>
